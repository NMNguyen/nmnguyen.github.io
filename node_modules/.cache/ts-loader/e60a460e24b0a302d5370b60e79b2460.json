{"remainingRequest":"/Volumes/Data/app.cloudjet.work/node_modules/babel-loader/lib/index.js!/Volumes/Data/app.cloudjet.work/node_modules/ts-loader/index.js??ref--13-2!/Volumes/Data/app.cloudjet.work/src/models/base.ts","dependencies":[{"path":"/Volumes/Data/app.cloudjet.work/src/models/base.ts","mtime":1557830879591},{"path":"/Volumes/Data/app.cloudjet.work/node_modules/cache-loader/dist/cjs.js","mtime":1557114467143},{"path":"/Volumes/Data/app.cloudjet.work/node_modules/babel-loader/lib/index.js","mtime":1557114461372},{"path":"/Volumes/Data/app.cloudjet.work/node_modules/ts-loader/index.js","mtime":1557114465832}],"contextDependencies":[],"result":["import _typeof from \"/Volumes/Data/app.cloudjet.work/node_modules/@babel/runtime-corejs2/helpers/esm/typeof\";\nimport _objectSpread from \"/Volumes/Data/app.cloudjet.work/node_modules/@babel/runtime-corejs2/helpers/esm/objectSpread\";\nimport \"regenerator-runtime/runtime\";\nimport _asyncToGenerator from \"/Volumes/Data/app.cloudjet.work/node_modules/@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"/Volumes/Data/app.cloudjet.work/node_modules/@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"/Volumes/Data/app.cloudjet.work/node_modules/@babel/runtime-corejs2/helpers/esm/createClass\";\nimport { db } from '@/firebase/index';\n/*\n\nĐây là base Model, chúng ta sẽ viết những methods thường xuyên sử dụng cho các Models, ví dụ:\n\n- insert\n- update\n- delete\n- getById\n- query...\n\n */\n\nvar Model =\n/*#__PURE__*/\nfunction () {\n  function Model(COLLECTION) {\n    _classCallCheck(this, Model);\n\n    this.id = \"\";\n    this.createdAt = Date.now();\n    this.updatedAt = Date.now();\n    this.firestore = db;\n    this.COLLECTION = COLLECTION;\n    this.constructor['COLLECTION'] = COLLECTION;\n  } // create new instance, not single instance, instead of (new Model())\n\n\n  _createClass(Model, [{\n    key: \"deserialize\",\n    value: function deserialize(data) {\n      Object.assign(this, data);\n    }\n  }, {\n    key: \"insert\",\n    value: function () {\n      var _insert = _asyncToGenerator(\n      /*#__PURE__*/\n      regeneratorRuntime.mark(function _callee() {\n        var modelCollection, result, model;\n        return regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                modelCollection = this.firestore.collection(this.COLLECTION);\n                result = _objectSpread({}, this);\n                delete result['firestore'];\n                delete result['COLLECTION'];\n                delete result['id']; //const {TIMESTAMP} = firebase.database.ServerValue;\n\n                result.createdAt = Date.now(); //TIMESTAMP;\n\n                result.updatedAt = Date.now(); //TIMESTAMP;\n\n                _context.next = 9;\n                return modelCollection.add(JSON.parse(JSON.stringify(result)));\n\n              case 9:\n                model = _context.sent;\n                this.id = model.id;\n                return _context.abrupt(\"return\", this);\n\n              case 12:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function insert() {\n        return _insert.apply(this, arguments);\n      }\n\n      return insert;\n    }()\n  }, {\n    key: \"upsert\",\n    value: function () {\n      var _upsert = _asyncToGenerator(\n      /*#__PURE__*/\n      regeneratorRuntime.mark(function _callee2() {\n        return regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                if (!this.id) {\n                  _context2.next = 6;\n                  break;\n                }\n\n                _context2.next = 3;\n                return this.update();\n\n              case 3:\n                return _context2.abrupt(\"return\", _context2.sent);\n\n              case 6:\n                _context2.next = 8;\n                return this.insert();\n\n              case 8:\n                return _context2.abrupt(\"return\", _context2.sent);\n\n              case 9:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function upsert() {\n        return _upsert.apply(this, arguments);\n      }\n\n      return upsert;\n    }()\n  }, {\n    key: \"update\",\n    value: function () {\n      var _update = _asyncToGenerator(\n      /*#__PURE__*/\n      regeneratorRuntime.mark(function _callee3() {\n        var modelCollection, result, id, model;\n        return regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                modelCollection = this.firestore.collection(this.COLLECTION);\n                result = _objectSpread({}, this);\n                id = result['id'];\n                delete result['firestore'];\n                delete result['COLLECTION'];\n                delete result['id']; // const {TIMESTAMP} = firebase.database.ServerValue;\n\n                result.updatedAt = Date.now(); // @ts-ignore\n\n                _context3.next = 9;\n                return modelCollection.doc(id).set(JSON.parse(JSON.stringify(result), {\n                  merge: true\n                }));\n\n              case 9:\n                model = _context3.sent;\n                return _context3.abrupt(\"return\", this);\n\n              case 11:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function update() {\n        return _update.apply(this, arguments);\n      }\n\n      return update;\n    }()\n  }, {\n    key: \"delete\",\n    value: function () {\n      var _delete2 = _asyncToGenerator(\n      /*#__PURE__*/\n      regeneratorRuntime.mark(function _callee4() {\n        var modelCollection, record;\n        return regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                modelCollection = this.firestore.collection(this.COLLECTION);\n                _context4.next = 3;\n                return modelCollection.doc(this.id);\n\n              case 3:\n                record = _context4.sent;\n                return _context4.abrupt(\"return\", record.delete());\n\n              case 5:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function _delete() {\n        return _delete2.apply(this, arguments);\n      }\n\n      return _delete;\n    }()\n  }, {\n    key: \"collection\",\n    value: function collection() {\n      return db.collection(this.COLLECTION);\n    }\n  }, {\n    key: \"getById\",\n    value: function () {\n      var _getById = _asyncToGenerator(\n      /*#__PURE__*/\n      regeneratorRuntime.mark(function _callee5(id) {\n        var modelCollection, record;\n        return regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                modelCollection = this.firestore.collection(this.COLLECTION);\n                _context5.next = 3;\n                return modelCollection.doc(id).get();\n\n              case 3:\n                record = _context5.sent;\n\n                if (record.exists) {\n                  _context5.next = 6;\n                  break;\n                }\n\n                throw new Error(\"\".concat(this.COLLECTION, \" \").concat(id, \" not found\"));\n\n              case 6:\n                this.id = record.id;\n                Object.assign(this, record.data()); // test\n\n                this.onChange(function () {});\n                return _context5.abrupt(\"return\", this);\n\n              case 10:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function getById(_x) {\n        return _getById.apply(this, arguments);\n      }\n\n      return getById;\n    }()\n  }, {\n    key: \"onChange\",\n    value: function onChange(callback) {\n      var _this = this;\n\n      var collection = this.firestore.collection(this.COLLECTION);\n      if (!this.id) return;\n      collection.doc(this.id).onSnapshot(function (docSnap) {\n        if (typeof callback === \"function\") {\n          var isPreventDefault = callback(null, docSnap.data());\n\n          if (!isPreventDefault) {\n            // console.info(\"Auto update object: \", this);\n            Object.assign(_this, docSnap.data());\n          }\n        }\n      }, function (error) {\n        if (typeof callback === \"function\") {\n          callback(error, null);\n        }\n      });\n    }\n  }], [{\n    key: \"from\",\n    value: function from() {\n      var data = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      var id = arguments.length > 1 ? arguments[1] : undefined;\n      var newObj = this.instance;\n      var obj = _typeof(data) === 'object' ? data : {};\n      Object.assign(newObj, obj, {\n        id: id\n      }); // test\n\n      newObj.onChange(function () {});\n      return newObj;\n    }\n  }, {\n    key: \"instance\",\n    get: function get() {\n      throw new TypeError('override this');\n    }\n  }]);\n\n  return Model;\n}();\n\nexport { Model as default };",{"version":3,"sources":["/Volumes/Data/app.cloudjet.work/src/models/base.ts"],"names":[],"mappings":"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","sourcesContent":["import {db} from '@/firebase/index'\nimport * as firebase from \"firebase\";\nimport DocumentSnapshot = firebase.firestore.DocumentSnapshot;\nimport Type from \"@/components/portal/Type.vue\";\n\n/*\n\nĐây là base Model, chúng ta sẽ viết những methods thường xuyên sử dụng cho các Models, ví dụ:\n\n- insert\n- update\n- delete\n- getById\n- query...\n\n */\n\nexport default class Model {\n    static COLLECTION: string;\n    COLLECTION: string;\n    firestore: firebase.firestore.Firestore;\n    id: string = \"\";\n    createdAt: number = Date.now();\n    updatedAt: number = Date.now();\n\n    // create new instance, not single instance, instead of (new Model())\n    static get instance(): Model {\n        throw new TypeError('override this');\n    }\n    static from(data: Object = {}, id?: string) {\n        const newObj = this.instance;\n        const obj = typeof data === 'object' ? data : {};\n        Object.assign(newObj, obj, {id});\n        // test\n        newObj.onChange(()=>{});\n\n        return newObj;\n    }\n\n    constructor(COLLECTION: string) {\n        this.firestore = db;\n        this.COLLECTION = COLLECTION;\n        this.constructor['COLLECTION'] = COLLECTION;\n    }\n\n\n    deserialize(data: Object) {\n        Object.assign(this, data);\n    }\n\n    async insert(): Promise<Model> {\n        const modelCollection = this.firestore.collection(this.COLLECTION);\n        let result = {...this};\n        delete result['firestore'];\n        delete result['COLLECTION'];\n        delete result['id'];\n\n        //const {TIMESTAMP} = firebase.database.ServerValue;\n        result.createdAt = Date.now(); //TIMESTAMP;\n        result.updatedAt = Date.now(); //TIMESTAMP;\n\n        const model = await modelCollection.add(JSON.parse(JSON.stringify(result)));\n        this.id = model.id;\n\n        return this;\n    }\n\n    async upsert(): Promise<Model> {\n        if (this.id) {\n            return await this.update();\n        } else {\n            return await this.insert();\n        }\n    }\n\n    async update(): Promise<Model> {\n        const modelCollection = this.firestore.collection(this.COLLECTION);\n\n        let result = {...this};\n        let id = result['id'];\n        delete result['firestore'];\n        delete result['COLLECTION'];\n        delete result['id'];\n\n        // const {TIMESTAMP} = firebase.database.ServerValue;\n        result.updatedAt = Date.now();\n\n        // @ts-ignore\n        const model = await modelCollection.doc(id).set(JSON.parse(JSON.stringify(result), {merge: true}));\n\n        return this;\n    }\n\n    async delete(): Promise<void> {\n\n        const modelCollection = this.firestore.collection(this.COLLECTION);\n        const record = await modelCollection.doc(this.id);\n\n        return record.delete();\n    }\n\n    public collection(): firebase.firestore.CollectionReference {\n        return db.collection(this.COLLECTION);\n    }\n\n\n    public async getById(id: string): Promise<Model> {\n        const modelCollection = this.firestore.collection(this.COLLECTION);\n        const record = await modelCollection.doc(id).get();\n        if (!record.exists) {\n            throw new Error(`${this.COLLECTION} ${id} not found`);\n        }\n\n        this.id = record.id;\n        Object.assign(this, record.data());\n\n        // test\n        this.onChange(()=>{});\n\n        return this;\n    }\n\n    onChange(callback: Function) {\n        const collection = this.firestore.collection(this.COLLECTION);\n        if (!this.id) return;\n        collection.doc(this.id)\n            .onSnapshot((docSnap: DocumentSnapshot)=>{\n                if (typeof callback === \"function\") {\n                    const isPreventDefault = callback(null, docSnap.data());\n                    if (!isPreventDefault) {\n                        // console.info(\"Auto update object: \", this);\n                        Object.assign(this, docSnap.data());\n                    }\n                }\n            }, (error) => {\n                if (typeof callback === \"function\") {\n                    callback(error, null);\n                }\n            })\n    }\n}\n"],"sourceRoot":""}]}